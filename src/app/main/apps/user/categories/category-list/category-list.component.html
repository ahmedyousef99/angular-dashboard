<div class="content-wrapper container-xxl p-0">
  <app-content-header [contentHeader]="contentHeader"></app-content-header>
  <ngb-alert
    [animation]="true"
    *ngIf="ResMessage"
    [type]="'success'"
    [dismissible]="true"
  >
    <div class="alert-body">{{ ResMessage }}</div>
  </ngb-alert>
  <div class="content-body">
    <section class="users-list-wrapper">
      <div class="card">
        <div class="row">
          <div class="col-md-6 col-12">
            <div class="d-flex justify-content-between align-items-center m-1">
              <label class="d-flex align-items-center">
                Show
                <select
                  (change)="onSelectChange($event)"
                  class="form-control mx-25"
                >
                  <option value="5">5</option>
                  <option value="10">10</option>
                  <option value="15">15</option>
                  <option value="20">20</option>
                </select>
                entries
              </label>
            </div>
          </div>
          <div
            class="col-md-6 col-12 d-flex justify-content-start justify-content-md-end"
          >
            <div
              class="d-flex align-items-center justify-content-end pr-1 pb-1 pb-md-0"
            >
              <button
                class="btn btn-primary ml-1"
                rippleEffect
                (click)="modalOpenForm(modalFormCategory)"
              >
                <i
                  data-feather="plus"
                  class="d-sm-none d-inline-block mr-0 mr-sm-1"
                ></i>
                <span class="d-none d-sm-inline-block">Add New Category</span>
              </button>
            </div>
          </div>
        </div>

        <ngx-datatable
          [rows]="rows"
          [rowHeight]="80"
          class="bootstrap core-bootstrap"
          [columnMode]="ColumnMode.force"
          [headerHeight]="50"
          [footerHeight]="50"
          [scrollbarH]="true"
          [externalPaging]="true"
          [treeFromRelation]="'parentId'"
          [treeToRelation]="'id'"
          (treeAction)="onTreeAction($event)"
          [limit]="page.size"
          [offset]="page.pageNumber"
          (page)="setPage($event)"
          [count]="rows.length"
        >
          <ngx-datatable-column
            [sortable]="false"
            [isTreeColumn]="true"
            [width]="1"
            [treeLevelIndent]="20"
          ></ngx-datatable-column>

          <ngx-datatable-column
            [sortable]="false"
            name="User"
            prop="fullName"
            [width]="180"
          >
            <ng-template
              let-row="row"
              let-name="value"
              ngx-datatable-cell-template
            >
              <div class="d-flex align-items-center">
                <div *ngIf="row?.image?.length > 0; else customAvatar">
                  <img
                    class="rounded-circle mr-1"
                    [src]="row?.image"
                    height="60"
                    width="60"
                    alt="User avatar"
                  />
                </div>
                <ng-template #customAvatar>
                  <div
                    class="avatar mr-1 ml-0"
                    [ngClass]="{
                      'badge-light-success': row?.isActive,
                      'badge-light-secondary': row?.isActive
                    }"
                  >
                    <div class="avatar-content">{{ name | initials }}</div>
                  </div>
                </ng-template>
                <div class="cell-line-height">
                  <a
                    routerLink="/apps/user/category-view/{{ row?.id }}"
                    class="font-medium-1 d-block"
                  >
                    <span class="font-weight-bold">{{ row?.nameEn }}</span>
                  </a>
                </div>
              </div>
            </ng-template>
          </ngx-datatable-column>

          <ngx-datatable-column
            [sortable]="false"
            name="Status"
            prop="status"
            [width]="50"
          >
            <ng-template let-row="row" ngx-datatable-cell-template>
              <div
                class="badge badge-pill"
                [ngClass]="{
                  'badge-light-success': row?.isActive,
                  'badge-light-danger': !row?.isActive
                }"
              >
                {{ row?.isActive ? "Active" : "Inactive" }}
              </div>
            </ng-template>
          </ngx-datatable-column>

          <ngx-datatable-column [sortable]="false" name="Actions" [width]="40">
            <ng-template ngx-datatable-cell-template let-row="row">
              <div ngbDropdown container="body">
                <button
                  ngbDropdownToggle
                  type="button"
                  class="btn icon-btn text-primary btn-sm hide-arrow"
                  rippleEffect
                >
                  <span
                    [data-feather]="'more-vertical'"
                    class="cursor-pointer"
                  ></span>
                </button>
                <div ngbDropdownMenu>
                  <a
                    routerLink="/apps/user/category-view/{{ row.id }}"
                    ngbDropdownItem
                  >
                    <span
                      [data-feather]="'file-text'"
                      size="16"
                      class="mr-50"
                    ></span>
                    Details
                  </a>
                  <a
                    (click)="modalOpenForm(modalFormCategory, 'edit', row)"
                    ngbDropdownItem
                  >
                    <span
                      [data-feather]="'edit'"
                      size="16"
                      class="mr-50"
                    ></span>
                    Edit
                  </a>
                  <a
                    (click)="modalOpenWarning(modalWarning, row?.id, row?.name)"
                    ngbDropdownItem
                  >
                    <span
                      [data-feather]="'trash'"
                      size="16"
                      class="mr-50"
                    ></span>
                    Delete
                  </a>
                </div>
              </div>
            </ng-template>
          </ngx-datatable-column>

          <ngx-datatable-column
            [sortable]="false"
            name="Sub Category"
            [width]="40"
            [sortable]="false"
          >
            <ng-template ngx-datatable-cell-template let-row="row">
              <button
                *ngIf="!row.parentId"
                class="btn btn-primary"
                rippleEffect
                (click)="modalOpenForm(modalFormCategory, 'newSub', row)"
              >
                <i data-feather="plus" class="mr-0"></i>
              </button>
            </ng-template>
          </ngx-datatable-column>
        </ngx-datatable>
      </div>
    </section>

    <ng-template #modalWarning let-modal>
      <div class="modal-header">
        <h5 class="modal-title">Delete Category</h5>
        <button
          type="button"
          class="close"
          (click)="modal.dismiss('Cross click')"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this category?
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-warning"
          (click)="onDelete()"
          rippleEffect
        >
          <span *ngIf="!deleteLoader">Delete</span>
          <div
            *ngIf="deleteLoader"
            class="spinner-border text-light"
            role="status"
            style="width: 1rem; height: 1rem"
          >
            <span class="sr-only">Loading...</span>
          </div>
        </button>
      </div>
    </ng-template>
  </div>
</div>

<ng-template #modalFormCategory let-modal>
  <div class="modal-header">
    <h4 *ngIf="!formType" class="modal-title">New Category</h4>
    <h4 *ngIf="formType" class="modal-title">Update Category</h4>
    <button
      type="button"
      class="close"
      (click)="onCloseModal()"
      aria-label="Close"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <ngb-alert *ngIf="formMessage" [type]="'danger'" [dismissible]="false">
      <div class="alert-body">{{ formMessage }}</div>
    </ngb-alert>
    <h4 *ngIf="mainCatName">
      This will be under
      <strong class="text-primary">{{ mainCatName }}</strong> category
    </h4>
    <form (ngSubmit)="(categoryForm.valid)" [formGroup]="categoryForm">
      <div>
        <ng-container *ngFor="let lang of ['En', 'Ar', 'Es']">
          <div class="form-group">
            <label class="form-label" for="name{{ lang }}"
              >Name In {{ lang }}</label
            >
            <input
              formControlName="name{{ lang }}"
              type="text"
              class="form-control dt-full-name"
              id="name{{ lang }}"
              placeholder="Name In {{ lang }}"
              required
              aria-label="Name In {{ lang }}"
              [class.error]="submitted && f['name' + lang].errors"
            />
            <span
              *ngIf="submitted && f['name' + lang].errors"
              class="invalid-form"
            >
              <small class="form-text text-danger"
                >This field is required!</small
              >
            </span>
          </div>
        </ng-container>
        <div *ngIf="formType" class="form-group">
          <label for="status">Activation</label>
          <select formControlName="isActive" class="form-control" id="status">
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>

        <div class="form-group">
          <div class="media mb-2">
            <div *ngIf="avatarImage; else customAvatar">
              <img
                class="user-avatar users-avatar-shadow rounded mr-2 my-25 cursor-pointer"
                [src]="avatarImage"
                height="90"
                width="90"
                alt="User avatar"
              />
            </div>
            <ng-template #customAvatar>
              <div
                [ngClass]="submitted && f.image.errors ? 'image-error' : ''"
                class="mr-1 ml-0 bg-light-secondary"
              >
                <div class="rounded p-3">
                  {{ categoryForm.get("nameEn").value | initials }}
                </div>
              </div>
            </ng-template>
            <div class="media-body mt-50">
              <div class="col-12 d-flex mt-1 px-0">
                <label class="btn btn-primary mr-75 mb-0" for="change-picture">
                  <span class="d-none d-sm-block">Add Image</span>
                  <input
                    class="form-control"
                    type="file"
                    id="change-picture"
                    hidden
                    accept="image/png, image/jpeg, image/jpg"
                    (change)="uploadImage($event)"
                  />
                </label>
                <button
                  (click)="clearImage()"
                  class="btn btn-outline-danger ml-1"
                  rippleEffect
                >
                  Delete
                </button>
              </div>
            </div>
          </div>
          <span *ngIf="submitted && f.image.errors" class="invalid-form">
            <small class="form-text text-danger">This field is required!</small>
          </span>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer d-flex flex-column align-items-end">
    <div>
      <button
        type="submit"
        class="btn btn-primary mr-1"
        (click)="submit()"
        rippleEffect
      >
        <span *ngIf="!isSubmitLoading">Submit</span>
        <div *ngIf="isSubmitLoading">
          <span
            class="spinner-border spinner-border-sm"
            role="status"
            aria-hidden="true"
          ></span>
          <span class="ml-25 align-middle">Loading...</span>
        </div>
      </button>
      <button
        type="reset"
        class="btn btn-outline-secondary"
        (click)="onCloseModal()"
        rippleEffect
      >
        Cancel
      </button>
    </div>
    <br />
  </div>
</ng-template>
<block-ui></block-ui>
